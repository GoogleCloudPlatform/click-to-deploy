# Copyright 2019 Google LLC
#
# This software is licensed under the Open Software License version
# 3.0. The full text of this license can be found in https://opensource.org/licenses/OSL-3.0
# or in the file LICENSE which is distributed along with the software.

setup:
- command: [docker, network, create, -d, bridge, testbridge-$UNIQUE-id]
- command: [docker, run, --net, testbridge-$UNIQUE-id, --name, some-redis-$UNIQUE-id, -d, -p, '6379:6379', 'marketplace.gcr.io/google/redis6', --requirepass', dragonfly]
- command: [docker, run, --net, testbridge-$UNIQUE-id, --name, some-mysql-$UNIQUE-id, -d, -p, '3306:3306', -e, 'MARIADB_USER=dragonfly', -e, 'MARIADB_PASSWORD=dragonfly', -e, 'MARIADB_DATABASE=manager', -e, 'MARIADB_ALLOW_EMPTY_ROOT_PASSWORD=yes', marketplace.gcr.io/google/mariadb10]
- command: [sleep, 5s]
- command: [docker, run, --net, testbridge-$UNIQUE-id, --name, some-dragonfly-manager-$UNIQUE-id, -d, -p, '8080:8080',-p, '65003:65003', -e, 'DRAGONFLY_MYSQL_HOST=some-mysql-$UNIQUE-id', -e, 'DRAGONFLY_REDIS_HOST=some-redis-$UNIQUE-id', $IMAGE]
- command: [sleep, 60s]

teardown:
- command: [docker, stop, some-redis-$UNIQUE-id, some-mysql-$UNIQUE-id, some-dragonfly-manager-$UNIQUE-id]
- command: [docker, rm, some-redis-$UNIQUE-id, some-mysql-$UNIQUE-id, some-dragonfly-manager-$UNIQUE-id]
- command: [docker, network, rm, testbridge-$UNIQUE-id]

target: some-dragonfly-manager-$UNIQUE-id
tests:
- name: test manager console page 
  command: [curl, -L, 'http://some-dragonfly-manager-$UNIQUE-id:8080']
  expect:
    stdout:
      matches: 'dragonfly'