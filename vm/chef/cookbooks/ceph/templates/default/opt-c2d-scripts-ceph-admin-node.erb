#!/bin/bash -eu
#
# Copyright 2018 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

source /opt/c2d/c2d-utils || exit 1

set +e
MON_IP="$(get_internal_ip)"
HOSTNAME="$(hostname --fqdn)"
CONFIGNAME="$(get_attribute_value ceph-config-name)"
set -e
DEPUSER=<%= node['ceph']['deploymentuser'] %>
DEPUSERHOME="/home/${DEPUSER}"
CEPHVERSION=<%= node['ceph']['version'] %>
CEPHNODES="$(get_attribute_value data-nodes)"
RSYNC_DIR=<%= node['ceph']['rsync-dir'] %>
DATADISKS="$(get_attribute_value number-of-data-disks)"

sudo su - ${DEPUSER}
sudo cephadm bootstrap --mon-ip ${MON_IP} --skip-mon-network --ssh-user ${DEPUSER}
sudo cephadm add-repo --release ${CEPHVERSION}
sudo cephadm install ceph-common

sudo cp ${DEPUSERHOME}/.ssh/authorized_keys ${RSYNC_DIR}
sudo chown ${DEPUSER}:${DEPUSER} ${RSYNC_DIR}/authorized_keys
sudo chmod 0755 ${RSYNC_DIR}/authorized_keys

sleep 30

for NODE in ${CEPHNODES}; do
  sudo ceph orch host add ${NODE}
  sleep 10
done

sudo ceph orch apply osd --all-available-devices
