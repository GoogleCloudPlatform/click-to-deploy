apiVersion: "v1"
kind: "Service"
metadata:
  name: {{ .Release.Name }}-exporter
  labels: &SolrDeploymentLabels
    app.kubernetes.io/name: {{ .Release.Name }}
    app.kubernetes.io/component: solr-exporter
spec:
  type: "ClusterIP"
  ports:
    - port: 9983
      name: "solr-client"
  selector: *SolrDeploymentLabels
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-exporter
  labels: &SolrDeploymentLabels
    app.kubernetes.io/name: {{ .Release.Name }}
    app.kubernetes.io/component: solr-exporter
spec:
  selector:
    matchLabels: *SolrDeploymentLabels
  replicas: 1
  revisionHistoryLimit: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels: *SolrDeploymentLabels
    spec:
      affinity:
        null
      containers:
        - name: exporter
          image: "{{ .Values.solr.image.repo }}:{{ .Values.solr.image.tag }}"
          imagePullPolicy: IfNotPresent
          {{- if not .Values.solr.development }}
          env:
            - name: ZK_READONLY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-solr-secret
                  key: zk-readonly-password
            - name: SOLR_ZK_READONLY_CREDS
              value: "-DzkACLProvider=org.apache.solr.common.cloud.VMParamsAllAndReadonlyDigestZkACLProvider -DzkCredentialsProvider=org.apache.solr.common.cloud.VMParamsSingleSetCredentialsDigestZkCredentialsProvider -DzkDigestUsername=readonly-user -DzkDigestPassword=$(ZK_READONLY_PASSWORD)"
            - name: JAVA_OPTS
              value: "$(SOLR_ZK_READONLY_CREDS)"
          {{- end }}
          resources:
            {}
          ports:
            - containerPort: 8983
              name: solr-client
          command:
            - "/opt/solr/contrib/prometheus-exporter/bin/solr-exporter"
            - "-p"
            - "9983"
            {{- if not .Values.solr.development }}
            - "-z"
            - "{{ .Release.Name }}-zk-client:2181"
            {{- end }}
            - "-n"
            - "7"
            - "-f"
            - "/opt/solr/contrib/prometheus-exporter/conf/solr-exporter-config.xml"
          livenessProbe:
            initialDelaySeconds: 20
            periodSeconds: 10
            httpGet:
              path: "/metrics"
              port: 9983
          readinessProbe:
            initialDelaySeconds: 15
            periodSeconds: 5
            httpGet:
              path: "/metrics"
              port: 9983
      initContainers:
        - name: solr-init
          image: "{{ .Values.solr.image.repo }}:{{ .Values.solr.image.tag }}"
          imagePullPolicy: IfNotPresent
          command:
            - 'sh'
            - '-c'
            - |
              PROTOCOL="http://"
              COUNTER=0;
              while [  $COUNTER -lt 30 ]; do
                curl -k -s --connect-timeout 10 "${PROTOCOL}{{ .Release.Name }}-svc:8983/solr/admin/info/system" && exit 0
                sleep 2
              done;
              echo "Did NOT see a Running Solr instance after 60 secs!";
              exit 1;
