actions:
- name: Wait for the TiKV get ready
  bashTest:
    script: |
      kubectl wait --for=condition=ready --timeout=120s --namespace $NAMESPACE pod "${APP_INSTANCE_NAME}-falco-0"
    expect:
      exitCode:
        equals: 0

- name: Are there all Falco pods healthy
  bashTest:
    script: |-
      kubectl exec --namespace $NAMESPACE "${APP_INSTANCE_NAME}-falco-0" -c falco -- curl localhost:8765/healthz
    expect:
      exitCode:
        equals: 0

- name: Is Falco /metrics HTTP endpoint working for Prometheus metrics
  bashTest:
    script: |-
      sleep 20
      curl -s -f "http://${SERVICE}:9376/metrics"
    expect:
      stdout:
        contains: '# TYPE promhttp'
      exitCode:
        equals: 0
