actions:
- name: Check if zookeeper shows 3 live kafka brokers
  bashTest:
    script: |
          echo dump | nc ${APP_INSTANCE_NAME}-zk-client 2181 | grep brokers | wc -l | grep 3
    expect:
      stdout:
        matches: "3"
      exitCode:
        equals: 0
- name: Check if Kafka broker service shows 3 live brokers
  bashTest:
    script: |
          kafkacat -L -b ${APP_INSTANCE_NAME}-kafka-svc
    expect:
      exitCode:
        equals: 0
      stdout:
        matches: 3 brokers.
- name: Produces a message in broker 1
  bashTest:
    script: |
      BROKER_ID=1001
      BROKER_IP=$(kafkacat -L -b ${APP_INSTANCE_NAME}-kafka-svc|grep "broker $BROKER_ID" | grep -E -o "([0-9]{1,3}[\.]){3}[0-9]{1,3}" )
      echo "Test from Docker Testrunner" | kafkacat -P -b $BROKER_IP -t test
    expect:
      exitCode:
        equals: 0
- name: Consumes message in broker 2
  bashTest:
    script: |
      BROKER_ID=1002
      BROKER_IP=$(kafkacat -L -b ${APP_INSTANCE_NAME}-kafka-svc|grep "broker $BROKER_ID" | grep -E -o "([0-9]{1,3}[\.]){3}[0-9]{1,3}" )
      kafkacat -b $BROKER_IP -t test -e
    expect:
      exitCode:
        equals: 0
      stderr:
        matches: Test from Docker Testrunner
- name: Consumes message in broker 3
  bashTest:
    script: |
      BROKER_ID=1003
      BROKER_IP=$(kafkacat -L -b ${APP_INSTANCE_NAME}-kafka-svc|grep "broker $BROKER_ID" | grep -E -o "([0-9]{1,3}[\.]){3}[0-9]{1,3}" )
      kafkacat -b $BROKER_IP -t test -e
    expect:
      exitCode:
        equals: 0
      stderr:
        matches: Test from Docker Testrunner
