apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Release.Name }}-kafka
  labels: &KafkaDeploymentLabels
    app.kubernetes.io/name: {{ .Release.Name }}
    app.kubernetes.io/component: kafka
spec:
  selector:
    matchLabels: *KafkaDeploymentLabels
  serviceName: {{ .Release.Name }}-kafka-headless
  {{- if not .Values.kafka.standalone }}
  replicas: {{ .Values.kafka.replicas }}
  {{- else }}
  replicas: 1
  {{- end }}
  updateStrategy:
        type: RollingUpdate
  template:
    metadata:
      labels: *KafkaDeploymentLabels
    spec:
      securityContext:
        fsGroup: 9092
        runAsUser: 9092
        runAsGroup: 9092
      terminationGracePeriodSeconds: 30
      {{- if and (not .Values.kafka.standalone) (.Values.kafka.auth_enable)}}
      volumes:
        - name: jaas-config
          secret:
            secretName: {{ .Release.Name }}-kafka-secrets
            items:
            - key: kafka_server_jaas.conf
              path: kafka_server_jaas.conf
              mode: 0755
      {{- end}}
      initContainers:
        {{- if not .Values.kafka.standalone }}
        - name: check-zk
          image: {{ .Values.deployer.image }}
          command:
            - 'sh'
            - '-c'
            - |
              COUNTER=0;
              while [  $COUNTER -lt 120 ]; do
                addr=$(nslookup -type=a {{ .Release.Name }}-zk-client | grep "Address:" | awk 'NR>1 {print $2}')
                if [ ! -z "$addr" ]; then
                  while read -r line; do
                    echo $line;
                    mode=$(echo srvr | nc $line 2181 | grep "Mode");
                    echo $mode;
                    if [ "$mode" = "Mode: leader" ] || [ "$mode" = "Mode: standalone" ]; then
                      echo "Found a leader!";
                      exit 0;
                    fi;
                  done <<EOF
              $addr
              EOF
                fi;
                let COUNTER=COUNTER+1;
                sleep 2;
              done;
              echo "Did NOT see a ZK leader after 240 secs!";
              exit 1;
        {{- end }}
      containers:
        - name: kafka
          image: "{{ .Values.kafka.image.repo }}:{{ .Values.kafka.image.tag }}"
          imagePullPolicy: IfNotPresent
          ports:
            - name: kafka-client
              containerPort: 9092
            - name: kafka-internal
              containerPort: 9093
          env:
            - name: BROKER_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: BROKER_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

            - name: STAS_DELAY
              value: "30"

            - name: KAFKA_INTER_BROKER_LISTENER_NAME
              value: "INTERNAL"

            - name: BROKER_ID_COMMAND
              value: "hostname | sed s/{{ .Release.Name }}-kafka-//"

            - name: KAFKA_ZOOKEEPER_CONNECT
              value: "{{ .Release.Name }}-zk-client.{{ .Release.Namespace }}.svc.cluster.local:2181"

            - name: KAFKA_LISTENERS
              value: "INTERNAL://$(BROKER_POD_IP):9093,CLIENT://$(BROKER_POD_NAME).{{ .Release.Name }}-kafka-headless.{{ .Release.Namespace }}.svc.cluster.local:9092"

            - name: KAFKA_ADVERTISED_LISTENERS
              value: "INTERNAL://$(BROKER_POD_IP):9093,CLIENT://$(BROKER_POD_NAME).{{ .Release.Name }}-kafka-headless.{{ .Release.Namespace }}.svc.cluster.local:9092"

            - name: KAFKA_LOG_DIRS
              value: "/kafka/logs"

#            - name: ZK_ADMIN_PASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: {{ .Release.Name }}-kafka-secret
#                  key: zk-admin-password
#            - name: ZK_READONLY_PASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: {{ .Release.Name }}-kafka-secret
#                  key: zk-readonly-password
#                  # export KAFKA_OPTS=-Djava.security.auth.login.config=<path-to-jaas-file>/users_jaas.conf
#            - name: KAFKA_ZK_CREDS_AND_ACLS
#              value: "-DzkACLProvider=org.apache.kafka.common.cloud.VMParamsAllAndReadonlyDigestZkACLProvider #-DzkCredentialsProvider=org.apache.kafka.common.cloud.#VMParamsSingleSetCredentialsDigestZkCredentialsProvider -DzkDigestUsername=admin-user #-DzkDigestPassword=$(ZK_ADMIN_PASSWORD) -DzkDigestReadonlyUsername=readonly-user #-DzkDigestReadonlyPassword=$(ZK_READONLY_PASSWORD)"
            #- name: KAFKA_OPTS
            #  value: "$(KAFKA_ZK_CREDS_AND_ACLS)"
            {{- if and (not .Values.kafka.standalone) (.Values.kafka.auth_enable)}}
            - name: KAFKA_OPTS
              value: "-Djava.security.auth.login.config=/tmp/kafka_server_jaas.conf"
            - name: KAFKA_SASL_ENABLED_MECHANISMS
              value: "PLAIN"
            - name: KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL
              value: "PLAIN"
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: "INTERNAL:PLAINTEXT,CLIENT:SASL_PLAINTEXT"
            {{- end }}
            {{- if and (not .Values.kafka.standalone) (not .Values.kafka.auth_enable)}}
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: "INTERNAL:PLAINTEXT,CLIENT:PLAINTEXT"
            {{- end }}
          livenessProbe:
            tcpSocket:
              port: kafka-client
            initialDelaySeconds: 20
            timeoutSeconds: 5
            failureThreshold: 1
            periodSeconds: 10
            successThreshold: 1
          readinessProbe:
            tcpSocket:
              port: kafka-client
            initialDelaySeconds: 20
            timeoutSeconds: 5
            failureThreshold: 1
            periodSeconds: 1
            successThreshold: 1
          volumeMounts:
            - name: logdir
              mountPath: /kafka
            {{- if and (not .Values.kafka.standalone) (.Values.kafka.auth_enable)}}
            - name: jaas-config
              mountPath: /tmp
            {{- end}}

  volumeClaimTemplates:
    - metadata:
        name: logdir
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: {{ .Values.persistence.storageClass }}
        resources:
          requests:
            storage: {{ .Values.persistence.kafka.storageSize }}
