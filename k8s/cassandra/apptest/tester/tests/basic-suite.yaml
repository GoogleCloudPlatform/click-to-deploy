actions:
- name: All nodes deployed successfully
  bashTest:
    script: |-
       declare -i replicas=$(kubectl get sts "${APP_INSTANCE_NAME}-cassandra" \
         --namespace "${NAMESPACE}" \
         --output jsonpath='{.spec.replicas}')

       for ((pod=0; pod<${replicas}; pod++)); do
         kubectl wait pod/${APP_INSTANCE_NAME}-cassandra-${pod} \
           --namespace=${NAMESPACE} \
           --for=condition=Ready \
           --timeout=300s
       done
    expect:
      exitCode:
        equals: 0
- name: There are exactly 3 nodes in a cluster
  bashTest:
    script: |-
       kubectl get sts "${APP_INSTANCE_NAME}-cassandra" \
         --namespace "${NAMESPACE}" \
         --output jsonpath='{.spec.replicas}'
    expect:
      stdout:
        equals: "3"
- name: Execute CQL query
  bashTest:
    script: |-
      set -e
      for i in $(seq 0 2); do
        export CQLSH_HOST=$APP_INSTANCE_NAME-cassandra-$i.$APP_INSTANCE_NAME-cassandra-svc.$NAMESPACE.svc.cluster.local
        cqlsh -e 'SHOW HOST' --cqlversion="3.4.4"
      done
    expect:
      exitCode:
        equals: 0
- name: Cluster is connected
  bashTest:
    script: |-
      set -e
      kubectl exec $APP_INSTANCE_NAME-cassandra-0 -- nodetool status | grep "^UN" -c
    expect:
      stdout:
        equals: "3"
      exitCode:
        equals: 0
- name: Can read/write data between nodes
  bashTest:
    script: |-
      set -e
        export CQLSH_HOST=$APP_INSTANCE_NAME-cassandra-0.$APP_INSTANCE_NAME-cassandra-svc.$NAMESPACE.svc.cluster.local
        cqlsh -e "CREATE KEYSPACE demo WITH REPLICATION ={'class':'SimpleStrategy', 'replication_factor' : 2};" --cqlversion="3.4.4" > /dev/null
        cqlsh -e "CREATE TABLE demo.person ( name varchar PRIMARY KEY );" --cqlversion="3.4.4" > /dev/null
        cqlsh -e "INSERT INTO demo.person  (name) VALUES ('John');" --cqlversion="3.4.4" > /dev/null

        export CQLSH_HOST=$APP_INSTANCE_NAME-cassandra-1.$APP_INSTANCE_NAME-cassandra-svc.$NAMESPACE.svc.cluster.local
        cqlsh -e "SELECT * FROM demo.person" --cqlversion="3.4.4"
    expect:
      stdout:
        contains: "John"
      exitCode:
        equals: 0
