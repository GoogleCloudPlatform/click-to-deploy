actions:
- name: kubectl smoke test
  bashTest:
    script: kubectl version
    expect:
      exitCode:
        equals: 0
- name: Wait for namespace creation
  bashTest:
    script: |
      timeout 120 bash -c '
      until kubectl get namespaces istio-system;
            do echo "Waiting for istio-system namespace..."; sleep 5;
      done'
    expect:
      exitCode:
        equals: 0
- name: Deploy Istio control plane
  bashTest:
    script: |
      kubectl apply -f - <<EOF
      apiVersion: install.istio.io/v1alpha1
      kind: IstioOperator
      metadata:
        namespace: istio-system
        name: example-istiocontrolplane
      spec:
        profile: default
      EOF
    expect:
      exitCode:
        equals: 0
- name: Wait for istiod deployment
  bashTest:
    script: |
      timeout 600 bash -c '
      until kubectl get services -n istio-system | grep istiod;
            do echo "Waiting for istiod to install..."; sleep 5;
      done'
    expect:
      exitCode:
        equals: 0
- name: Delete control plane
  bashTest:
    script: |
      kubectl delete istiooperators.install.istio.io -n istio-system example-istiocontrolplane
    expect:
      exitCode:
        equals: 0
- name: Wait for istiod deletion
  bashTest:
    script: |
      timeout 600 bash -c '
      until ! kubectl get deployments -n istio-system istiod;
            do echo "Waiting for istiod to be removed..."; sleep 5;
      done'
    expect:
      exitCode:
        equals: 0
